/*! homeservice 20-12-2013 */
"use strict";function AMQP(a,b){this.name=a,this.amqp=require("amqp"),this.moduleBus=b,this.config={host:"localhost",port:5672}}function CUL_FHTTK(){console.log("CUL_FHTTK Formatter")}function CUL_HM(){console.log("CUL_HM Formatter")}function FS20(){console.log("FS20 Formatter")}function PRESENCE(){console.log("PRESENCE Formatter")}function Weather(){console.log("Weather Formatter")}function defaultHandler(){console.log("defaultHandler Formatter")}function FHEM(a,b){this.name=a,this.moduleBus=b,this.handler={},this.handlerInstances={},this.config={maxAttepts:5,host:"192.168.178.20",port:7072,events:{publish:{event:[]},subscribe:{}}}}function Mongo(a,b){this.name=a,this.mongoose=require("mongoose"),this.moduleBus=b,this.schema={};var c=this.mongoose.Schema;this.config={dsn:"mongodb://localhost/test",expires:15552e3},this.schema.Event=this.mongoose.model("Event",new c({_facility:String,_device:String,_type:String,_date:{type:Date,expires:this.config.expires},_ts:Number,data:Object}))}function Rest(a,b){this.name=a,this.restify=require("restify"),this.moduleBus=b,this.data={},this.config={debug:!1,port:8080,docRoot:"",events:{publish:{},subscribe:{sockeio:["events"]}}}}function XMPP(a,b){this.name=a,this.moduleBus=b,this.xmpp=require("node-xmpp"),this.client={},this.defaultCmdNs="",this.config={jid:"",password:""}}function ObjectHelper(){}var amqp=require("amqp"),connection=amqp.createConnection({host:"localhost"});connection.on("ready",function(){connection.queue("hello",{autoDelete:!1},function(a){console.log(" [*] Waiting for messages. To exit press CTRL+C"),a.subscribe(function(a){console.log(" [x] Received %s",a.data.toString("utf-8"))})})});var Postal=require("postal"),postal=new Postal,Rest=require("./lib/Modules/Rest"),XMPP=require("./lib/Modules/XMPP"),AMQP=require("./lib/Modules/AMQP"),FHEM=require("./lib/Modules/FHEM"),Mongo=require("./lib/Modules/Mongo"),moduleBus=postal.channel(),rest=new Rest("rest",moduleBus),xmpp=new XMPP("xmpp.googleTalkFhem",moduleBus),amqp=new AMQP("amqp.rabbitmq",moduleBus),fhem=new FHEM("fhem.rpi",moduleBus),mongo=new Mongo("mongo.domo",moduleBus);amqp.options({host:"localhost",port:5672}),xmpp.options({jid:"fhem@lexsign.de",password:"fhempass",events:{}}),fhem.options({maxAttepts:10,host:"192.168.178.20",port:7072,events:{publish:{event:["rest.socketio.events","mongo.domo.Event","amqp.rabbitmq.amfhetamin.events"]},subscribe:{}}}),rest.options({debug:!0,port:8081,docRoot:__dirname+"/../public"}),mongo.options({dsn:"mongodb://localhost/homeservice"}),moduleBus.subscribe("*",function(a){console.log("moduleBus",a)}),mongo.run(),rest.run(),xmpp.run(),amqp.run(),fhem.run(),AMQP.prototype.run=function(){var a=this.amqp.createConnection({host:"localhost"});a.on("ready",function(){a.queue("xmpp",{autoDelete:!1},function(a){console.log(" [*] Waiting for XMPP messages. To exit press CTRL+C"),a.subscribe(function(a){console.log(" [x] Received %s",a.data.toString("utf-8"))})}),a.queue("fhem",{autoDelete:!1},function(a){console.log(" [*] Waiting for messages. To exit press CTRL+C"),a.subscribe(function(a){console.log(" [x] Received %s",a.data.toString("utf-8"))})})})},AMQP.prototype.options=function(a){var b,c;b=require("../../ObjectHelper"),c=new b,this.config=c.mergeRecursive(this.config,a)},module.exports=AMQP,CUL_FHTTK.prototype.handle=function(a){var b={};return b.open=-1!==a.data[0].indexOf("Open")?1:0,b.status=1===b.open?"open":"closed",a.data=b,a},module.exports=CUL_FHTTK,CUL_HM.prototype.handle=function(a){var b,c,d={};return a.data.forEach(function(a){if(b=new RegExp("(^\\w+):\\s(.*)$","g"),c=b.exec(a.trim()))switch(c[1]){case"temperature":case"humidity":case"RSSI":d[c[1]]=parseFloat(c[2]);break;case"T":break;default:d[c[1]]=c[2]}}),a.data=d,a},module.exports=CUL_HM,FS20.prototype.handle=function(a){var b={};return b.status=a.data[0],a.data=b,a},module.exports=FS20,PRESENCE.prototype.handle=function(a){var b={};return b.present="present"===a.data[0]?1:0,b.status=1===b.present?"present":"absent",a.data=b,a},module.exports=PRESENCE,Weather.prototype.handle=function(a){var b,c,d,e={},f=require("../../../ObjectHelper"),g=new f,h=require("moment");return a.data.forEach(function(a){if(a=a.replace("fc","forecast_day").replace("fc","forecast_day").replace("pressure:","pressure_value:").replace("condition:","condition_text:").replace("wind_condition_text:","wind_condition:").replace("wind:","wind_speed:").replace("code:","condition_code:").replace("day_of_week:","weekday:").replace("pressure_trend:","pressure_trend_change:").replace("low_c:","temperature_low:").replace("high_c:","temperature_high:").replace("temp_c:","").replace("temp_f:","").replace("current_date_time:","fetchdate:").replace(/T:.+H:.+W:.+/g,""),b=new RegExp("(^\\w+):\\s(.*)$","g"),c=b.exec(a.trim())){var f;switch(c[1]){case"fetchdate":f=h(c[2].replace("CET","+0100").replace("CEST","+0200"),["DD MMM YYYY h:mm a ZZ"]).toJSON();break;case"humidity":case"temperature":case"wind_chill":case"wind_speed":case"wind_direction":case"pressure_value":case"pressure_trend_change":case"forecast_day1_temperature_low":case"forecast_day1_temperature_high":case"forecast_day2_temperature_low":case"forecast_day2_temperature_high":case"forecast_day3_temperature_low":case"forecast_day3_temperature_high":case"forecast_day4_temperature_low":case"forecast_day4_temperature_high":case"forecast_day5_temperature_low":case"forecast_day5_temperature_high":f=parseFloat(c[2]);break;case"visibility":case"forecast_day1_condition_code":case"forecast_day2_condition_code":case"forecast_day3_condition_code":case"forecast_day4_condition_code":case"forecast_day5_condition_code":f=parseInt(c[2],10);break;default:f=c[2]}for(d=c[1].split("_");d.length;){var i={};i[d.pop()]=f,f=i}e=g.mergeRecursive(e,f)}}),a.data=e,a},module.exports=Weather,defaultHandler.prototype.handle=function(a){var b,c,d={};return a.data.forEach(function(a){b=new RegExp("(^\\w+):\\s(.*)$","g"),c=b.exec(a.trim()),c?d[c[1]]=c[2]:(d._raw=d._raw||[],d._raw.push(a.trim()))}),a.data=d,a},module.exports=defaultHandler,FHEM.prototype.run=function(){var a=0,b=require("net"),c=b.Socket(),d=[],e=this,f=function(){if(a<e.config.maxAttepts)a++,c=b.connect({host:e.config.host,port:e.config.port},function(){var b=new Date;a=0,console.log(b+" - FHEM at "+e.config.host+" - Connected"),c.setKeepAlive(!0),c.write("inform on\r\n")}),c.on("data",function(a){var b,c;c=a.toString().replace("\r\n","\n").split("\n"),d.length>0&&(d[c.length-1]+=c.splice(0,1).toString(),d=d.concat(c)),""!==c[c.length-1]?d=c:(d.length>0&&(c=d,d=[]),b=h(g(c)),b.forEach(function(a){e.config.events.publish.event.forEach(function(b){e.moduleBus.publish(b,a)})}))}),c.on("end",function(){var a=new Date;console.log(a+" - FHEM at "+e.config.host+" - Disconnected"),setTimeout(f,1e4)}),c.on("timeout",function(){var a=new Date;console.log(a+" - FHEM at "+e.config.host+" - Timed out"),setTimeout(f,1e4)}),c.on("error",function(a){var b=new Date;console.log(b+" - FHEM at "+e.config.host+" - Error:",a),setTimeout(f,1e4)});else{var i=new Date;console.log(i+" - FHEM connection lost"+e.config.maxAttepts+" times, no more tries")}};f();var g=function(a){var b,c,d,e,f={};return a.forEach(function(a){d={},""!==a&&(b=new RegExp("(^\\w+)\\s([\\w\\.]+)\\s(.*)$","gm"),c=b.exec(a.trim()),c&&(e=c[2],f[e]=f[e]||{},f[e]._facility="",f[e]._device=e,f[e]._type=c[1],f[e]._date={},f[e]._ts=0,f[e].data=f[e].data||[],f[e].data.push(c[3])))}),f},h=function(a){var b,c,d=[];return Object.keys(a).forEach(function(f){var g;b=a[f];try{e.handler[b._type]=e.handler[b._type]||require("./FHEM/Formatter/"+b._type)}catch(h){e.handler[b._type]=require("./Formatter/defaultFormatter")}e.handlerInstances[b._type]=e.handlerInstances[b._type]||new e.handler[b._type],c=e.handlerInstances[b._type].handle(b),g=new Date,c._facility=e.name,c._date=g,c._ts=g.getTime(),d.push(c)}),d}},FHEM.prototype.options=function(a){var b,c;b=require("../../ObjectHelper"),c=new b,this.config=c.mergeRecursive(this.config,a)},module.exports=FHEM,Mongo.prototype.run=function(){var a=this;this.mongoose.connect(this.config.dsn),Object.keys(a.schema).forEach(function(b){var c,d;c=a.schema[b],d=a.name+"."+b,a.moduleBus.subscribe(d,function(a){var b;b=new c(a),b.save(function(a){a&&console.log("mongo err",a)})})})},Mongo.prototype.options=function(a){var b,c;b=require("../../ObjectHelper"),c=new b,this.config=c.mergeRecursive(this.config,a)},module.exports=Mongo,Rest.prototype.options=function(a){var b,c;b=require("../../ObjectHelper"),c=new b,this.config=c.mergeRecursive(this.config,a)},Rest.prototype.run=function(){var a=this.restify.createServer().use(this.restify.fullResponse()).use(this.restify.bodyParser()),b=require("socket.io").listen(a),c=require("fs"),d=this,e={};b.set("log level",d.config.debug?3:1),console.log("socket io log level",b.get("log level")),b.sockets.on("connection",function(a){a.emit("messages",{msg:"start socket.io"}),d.config.events.subscribe.sockeio.forEach(function(b){var c=d.name+".socketio."+b;a.emit("messages",{msg:'listing for channel "'+b+'" on moduleBus "'+c+'"'}),d.moduleBus.subscribe(c,function(c){a.emit(b,c)})})}),this.moduleBus.subscribe("xmpp.status.res",function(a){e.xmpp=e.xmpp||{},e.xmpp.status=a}),a.get("/",function(a,b,e){c.readFile(d.config.docRoot+"/index.html",function(a,c){return a?(e(a),void 0):(b.setHeader("Content-Type","text/html"),b.writeHead(200),b.end(c),e(),void 0)})}),a.get(/^\/public\/?.*/,this.restify.serveStatic({directory:this.config.docRoot.replace("/public","")})),a.get("/xmpp/status",function(a,b){d.moduleBus.publish("xmpp.status.req",{}),b.send(200,{status:"success",data:e.xmpp.status})}),a.post("/xmpp/message",function(a,b,c){return void 0===a.params.message?c(new d.restify.InvalidArgumentError("message must be supplied")):(d.moduleBus.publish("xmpp.message",a.params),b.send(201,{status:"success",params:a.params}),void 0)}),a.listen(this.config.port,function(){console.log("%s listening at %s",a.name,a.url)})},module.exports=Rest,XMPP.prototype.run=function(){this.client=new this.xmpp.Client({jid:this.config.jid,password:this.config.password}),this.status={};var a=this;this.client.on("online",function(b){console.log("XMPP online"),a.status=b,a.client.send(new a.xmpp.Element("presence",{test:"test"}).c("show").t("chat").up().c("status").t("Happily echoing your <message/> stanzas"))}).on("stanza",function(b){b.is("message")&&void 0!==b.getChild("body")&&"error"!==b.attrs.type&&a.send(a.handleStanza(b))}).on("error",function(a){console.error(a)}),this.moduleBus.subscribe("xmpp.message",function(b){console.log("xmpp.message",b),a.send(b)}),this.moduleBus.subscribe("xmpp.status.req",function(){a.moduleBus.publish("xmpp.status.res",a.status)})},XMPP.prototype.send=function(a,b){a="alexander.kentner@lexsign.de",this.client.send(new this.xmpp.Element("message",{to:a,type:"chat"}).c("body").t(JSON.stringify(b)))},XMPP.prototype.handleStanza=function(a){var b,c,d;if(b="",a.getChild("body").children.forEach(function(a){b+=a}),c=new RegExp("^(help|use|fhem|test)\\s{0,1}.*"),d=c.exec(this.defaultCmdNs+" "+b.trim(),"g"),console.log(d),d)switch(d[1]){case"help":console.log("handle help:",d.input);break;case"use":d[2]&&(this.defaultCmdNs=d[2].match(/(help|use|fhem|test)/g).toString(),console.log("use:",this.defaultCmdNs)),console.log("handle use:",d.input);break;case"fhem":console.log("handle fhem:",d.input);break;case"test":console.log("handle test:",d.input)}return"meep"},XMPP.prototype.options=function(a){var b,c;b=require("../../ObjectHelper"),c=new b,this.config=c.mergeRecursive(this.config,a)},module.exports=XMPP,ObjectHelper.prototype.mergeRecursive=function(a,b){var c;for(c in b)if(c)try{a[c]=b[c].constructor===Object?this.mergeRecursive(a[c],b[c]):b[c]}catch(d){a[c]=b[c]}return a},module.exports=ObjectHelper;